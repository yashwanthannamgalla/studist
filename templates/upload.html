<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>{{ username }}'s Learning Files</title>
  <link href="https://fonts.googleapis.com/css?family=Inter:400,600&display=swap" rel="stylesheet" />
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg,#b7f8db 0%,#50a7c2 100%);
      color: #1d2336;
      margin: 0; padding: 40px 20px;
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
    }
    .container {
      max-width: 900px;
      width: 90%;
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
      padding: 32px 36px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    h2 {
      font-weight: 600;
      font-size: 2rem;
      text-align: center;
      color: #2f586e;
    }
    form.upload-form {
      display: flex;
      gap: 16px;
      justify-content: center;
    }
    input[type="file"] {
      padding: 12px 18px;
      border-radius: 12px;
      border: 1.5px solid #91eaca;
      background: #e3fdfa;
      font-size: 1.1rem;
      cursor: pointer;
    }
    button {
      background: linear-gradient(92deg,#43e97b 40%,#38f9d7 100%);
      color: white;
      border: none;
      border-radius: 12px;
      padding: 12px 30px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s filter, 0.18s transform;
      font-size: 1.1rem;
      white-space: nowrap;
    }
    button:hover {
      filter: brightness(1.1);
      transform: scale(1.05);
    }
    .file-card {
      background: linear-gradient(90deg,#f0f6ff 70%,#daf3ff 100%);
      padding: 18px 24px;
      border-radius: 14px;
      box-shadow: 0 5px 18px rgba(0,0,0,0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 1.1rem;
      font-weight: 600;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      word-break: break-word;
    }
    .file-card:hover {
      transform: scale(1.03);
      box-shadow: 0 12px 28px rgba(40,110,200,0.1);
    }
    .file-card button {
      padding: 8px 16px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      margin-left: 10px;
      font-size: 1rem;
      transition: 0.15s filter, 0.18s transform;
    }
    .read-btn {
      background: linear-gradient(90deg,#43e97b,#38f9d7);
      color: white;
    }
    .read-btn:hover {
      filter: brightness(1.15);
      transform: scale(1.08);
    }
    .delete-btn {
      background: #e74c3c;
      color: white;
    }
    .delete-btn:hover {
      filter: brightness(0.9);
      transform: scale(1.05);
    }
    .back-btn {
      max-width: 180px;
      margin: 0 auto;
      background: linear-gradient(90deg,#43e97b,#38f9d7);
      color: white;
      padding: 14px 0;
      border-radius: 16px;
      text-decoration: none;
      font-weight: 600;
      font-size: 1.1rem;
      text-align: center;
      transition: 0.2s filter, 0.18s transform;
      display: block;
    }
    .back-btn:hover {
      filter: brightness(1.08);
      transform: scale(1.06);
    }
    @media (max-width: 600px) {
      .file-card {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      form.upload-form {
        flex-direction: column;
        gap: 16px;
      }
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìÇ {{ username }}'s Learning Files</h2>

    <form class="upload-form" action="/upload?user={{ username }}" method="POST" enctype="multipart/form-data">
      <input type="file" name="file" required />
      <button type="submit">Upload</button>
    </form>

    {% if files %}
      {% for file in files %}
        <div class="file-card" title="{{ file }}">
          <span>{{ file }}</span>
          <div>
            <button class="read-btn" onclick="openPDF('{{ file }}')">Read</button>
            <form method="POST" action="/delete-file" style="display:inline;">
              <input type="hidden" name="username" value="{{ username }}">
              <input type="hidden" name="filename" value="{{ file }}">
              <button type="submit" class="delete-btn">Delete</button>
            </form>
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p style="text-align:center; font-style: italic; color: #666; margin-top: 20px;">No files uploaded yet.</p>
    {% endif %}

    <a href="/dashboard?user={{ username }}" class="back-btn">‚¨Ö Back to Dashboard</a>
  </div>

  <!-- PDF Overlay -->
  <div id="pdf-overlay" style="display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
    <canvas id="pdf-canvas" style="border-radius: 15px; box-shadow: 0 0 22px rgba(11,133,111,0.22); max-width: 95vw; max-height: 75vh;"></canvas>
    <div id="overlay-controls" style="margin-top: 10px; display:flex; gap:20px; justify-content:center;">
      <button id="prev-page">‚¨Ö Prev</button>
      <span id="page-info">Page 0 / 0</span>
      <button id="next-page">Next ‚û°</button>
      <button id="bookmark-btn">üîñ Bookmark Page</button>
      <button id="close-btn">‚ùå Close</button>
    </div>
  </div>

  <script src=\"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js\"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js';

    const username = \"{{ username }}\";
    const bookmarksKeyPrefix = \"pdf_bookmarks_\";
    let pdfDoc = null, currentFile = null, pageNum = 1;
    const scale = 1.5;
    const overlay = document.getElementById('pdf-overlay');
    const canvas = document.getElementById('pdf-canvas');
    const ctx = canvas.getContext('2d');
    const pageInfo = document.getElementById('page-info');
    const prevBtn = document.getElementById('prev-page');
    const nextBtn = document.getElementById('next-page');
    const bookmarkBtn = document.getElementById('bookmark-btn');
    const closeBtn = document.getElementById('close-btn');
    let pageRendering = false, pageNumPending = null;

    function renderPage(num) {
      pageRendering = true;
      pdfDoc.getPage(num).then(page => {
        const viewport = page.getViewport({scale: scale});
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        const renderTask = page.render({canvasContext: ctx, viewport: viewport});
        renderTask.promise.then(() => {
          pageRendering = false;
          pageInfo.textContent = `Page ${num} / ${pdfDoc.numPages}`;
        });
      });
      pageNum = num;
    }
    function queueRenderPage(num) {
      if (pageRendering) {
        pageNumPending = num;
      } else {
        renderPage(num);
      }
    }
    prevBtn.onclick = function() {
      if (!pdfDoc) return;
      if (pageNum <= 1) return;
      queueRenderPage(pageNum - 1);
    };
    nextBtn.onclick = function() {
      if (!pdfDoc) return;
      if (pageNum >= pdfDoc.numPages) return;
      queueRenderPage(pageNum + 1);
    };
    closeBtn.onclick = function() {
      overlay.style.display = 'none';
      pdfDoc = null;
      currentFile = null;
      canvas.width = canvas.height = 0;
      pageInfo.textContent = \"Page 0 / 0\";
    };
    bookmarkBtn.onclick = function() {
      if (!currentFile) return;
      const bookmarkKey = bookmarksKeyPrefix + username + '_' + currentFile;
      localStorage.setItem(bookmarkKey, pageNum);
      alert(`üîñ Bookmarked page ${pageNum} for ${currentFile}`);
    };
    function openPDF(file) {
      currentFile = file;
      const bookmarkKey = bookmarksKeyPrefix + username + '_' + file;
      const storedPage = parseInt(localStorage.getItem(bookmarkKey)) || 1;
      pdfjsLib.getDocument(`/uploads/${username}/${file}`).promise.then(pdf => {
        pdfDoc = pdf;
        pageNum = Math.min(Math.max(storedPage, 1), pdf.numPages);
        overlay.style.display = 'flex';
        renderPage(pageNum);
      }).catch(err => alert(\"Error loading PDF: \" + err.message));
    }
  </script>
</body>
</html>
